<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“… 3å€‹æœˆæ¸›è‚¥è¿½è¹¤ç³»çµ±ï¼ˆ90æ—¥ï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --text2:#cbd5e1;
      --primary:#38bdf8;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --line:#22304f;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:10px;
      --font:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang TC","Microsoft JhengHei",sans-serif;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f8fafc;
        --card:#ffffff;
        --card2:#f1f5f9;
        --muted:#64748b;
        --text:#0f172a;
        --text2:#334155;
        --primary:#0284c7;
        --line:#e2e8f0;
        --shadow:0 10px 30px rgba(2, 6, 23, .08);
      }
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.55;padding:18px}
    .wrap{max-width:920px;margin:0 auto}
    h1{font-size:26px;letter-spacing:.2px;text-align:center;margin:8px 0 6px;color:var(--primary)}
    .sub{font-size:13px;text-align:center;color:var(--muted);margin-bottom:16px}
    .grid{display:grid;grid-template-columns: 1.15fr .85fr;gap:14px}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{font-size:16px;color:var(--text2);margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{flex:1;min-width:160px;background:var(--card2);border:1px solid var(--line);border-radius:var(--radius2);padding:12px}
    .kpi .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .value{font-size:20px;font-weight:700}
    .kpi .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .barWrap{margin-top:12px;background:var(--card2);border:1px solid var(--line);border-radius:999px;overflow:hidden;height:16px}
    .bar{height:100%;width:0%;background:linear-gradient(90deg, var(--primary), var(--good));transition:width .4s ease}
    .barText{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width: 560px){ .form{grid-template-columns:1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    input, textarea, select{
      background:var(--card2);border:1px solid var(--line);border-radius:10px;
      color:var(--text);padding:10px 10px;font-size:14px;outline:none
    }
    textarea{min-height:86px;resize:vertical}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:none;border-radius:12px;padding:11px 14px;font-weight:700;
      cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.18)
    }
    .btnPrimary{background:var(--primary);color:var(--text)}
    .btnGhost{background:transparent;color:var(--text2);border:1px solid var(--line);box-shadow:none}
    .btnDanger{background:var(--bad);color:#fff}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .item{
      background:var(--card2);border:1px solid var(--line);border-radius:12px;padding:12px
    }
    .itemTop{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .itemDate{font-weight:800}
    .pill{font-size:12px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:var(--muted)}
    .itemMid{margin-top:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media (max-width: 640px){ .itemMid{grid-template-columns:1fr} }
    .mini{background:transparent;border:1px dashed var(--line);border-radius:10px;padding:8px}
    .mini .mLabel{font-size:12px;color:var(--muted)}
    .mini .mVal{font-size:14px;font-weight:700;margin-top:4px}
    .note{margin-top:8px;color:var(--text2);font-size:13px;white-space:pre-wrap}
    .tips ul{margin:8px 0 0 18px}
    .tips li{margin:6px 0;color:var(--text2);font-size:13px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .warnBox{
      background:rgba(245,158,11,.12);
      border:1px solid rgba(245,158,11,.35);
      padding:12px;border-radius:12px;color:var(--text2)
    }
    .goodBox{
      background:rgba(16,185,129,.12);
      border:1px solid rgba(16,185,129,.35);
      padding:12px;border-radius:12px;color:var(--text2)
    }
    .mono{font-variant-numeric: tabular-nums}
    canvas{width:100%;height:220px;background:transparent}
    .chartCard{padding:14px}
    .chartTitle{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“… 3å€‹æœˆæ¸›è‚¥è¿½è¹¤ç³»çµ±ï¼ˆ90æ—¥ï¼‰</h1>
  <div class="sub">
    é è¨­ï¼šç”± <span class="mono" id="startDateText"></span> é–‹å§‹ Â· ç›®æ¨™ï¼š90æ—¥æ¸› <span class="mono" id="goalLossText"></span> kg Â· è¨˜éŒ„æœƒå„²å­˜åœ¨ä½ éƒ¨æ‰‹æ©Ÿ/é›»è…¦ï¼ˆæœ¬æ©Ÿç€è¦½å™¨ï¼‰
  </div>

  <div class="grid">
    <div class="card">
      <h2>âœ… ä»Šæ—¥æ‰“å¡</h2>

      <div class="row">
        <div class="kpi">
          <div class="label">Day</div>
          <div class="value mono" id="dayNumber">â€”</div>
          <div class="hint" id="dayRangeHint">â€”</div>
        </div>
        <div class="kpi">
          <div class="label">ç¾æ™‚é«”é‡ï¼ˆæœ€æ–°ï¼‰</div>
          <div class="value mono" id="latestWeight">â€”</div>
          <div class="hint muted">kg</div>
        </div>
        <div class="kpi">
          <div class="label">è·é›¢ç›®æ¨™å°šå·®ï¼ˆä¼°ç®—ï¼‰</div>
          <div class="value mono" id="remainingToGoal">â€”</div>
          <div class="hint muted">kgï¼ˆæŒ‰æœ€æ–°é«”é‡è¨ˆï¼‰</div>
        </div>
      </div>

      <div class="barWrap" aria-label="progress">
        <div class="bar" id="progressBar"></div>
      </div>
      <div class="barText" id="progressText">æœªé–‹å§‹</div>

      <div class="sep"></div>

      <div class="form">
        <div class="field">
          <label>æ—¥æœŸ</label>
          <input type="date" id="entryDate"/>
        </div>

        <div class="field">
          <label>é«”é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="weight" placeholder="ä¾‹å¦‚ 70.5" step="0.1" min="30" max="200"/>
        </div>

        <div class="field">
          <label>é«”è„‚ï¼ˆ%ï¼‰</label>
          <input type="number" id="bodyfat" placeholder="ä¾‹å¦‚ 32.1ï¼ˆå¯ç•™ç©ºï¼‰" step="0.1" min="5" max="80"/>
        </div>

        <div class="field">
          <label>é‹å‹•ï¼ˆé è¨­ï¼šè·‘æ­¥ 2 / Gyro 1 æ¯é€±ï¼‰</label>
          <select id="workout">
            <option value="">ä»Šæ—¥å†‡åš</option>
            <option value="è·‘æ­¥">è·‘æ­¥</option>
            <option value="Gyrotonic">Gyrotonic</option>
            <option value="æ­¥è¡Œ/æ´»å‹•é‡">æ­¥è¡Œ/æ´»å‹•é‡</option>
            <option value="åŠ›é‡/æ ¸å¿ƒ">åŠ›é‡/æ ¸å¿ƒ</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label>é£²é£Ÿ/ç‹€æ³å‚™è¨»ï¼ˆIBS-D / PCOS / PMS / Ozempic ç›¸é—œéƒ½å¯ä»¥å¯«ï¼‰</label>
          <textarea id="notes" placeholder="ä¾‹å¦‚ï¼šæ—©é¤è›‹ç™½è³ªè¶³å¤ ï¼Ÿæœ‰å†‡è…¹ç€‰/è…¹ç—›ï¼Ÿä»Šæ—¥æ°´è…«ï¼Ÿé£Ÿå’—å’©è§¸ç™¼ï¼Ÿ"></textarea>
        </div>
      </div>

      <div class="btnRow">
        <button class="btnPrimary" onclick="saveEntry()">ğŸ’¾ å„²å­˜ä»Šæ—¥æ‰“å¡</button>
        <button class="btnGhost" onclick="exportJSON()">â¬‡ï¸ åŒ¯å‡ºè³‡æ–™ï¼ˆJSONï¼‰</button>
        <button class="btnGhost" onclick="importJSON()">â¬†ï¸ åŒ¯å…¥è³‡æ–™ï¼ˆJSONï¼‰</button>
        <button class="btnDanger" onclick="clearAll()">ğŸ§¨ æ¸…é™¤å…¨éƒ¨è¨˜éŒ„</button>
      </div>

      <div class="sep"></div>

      <div class="warnBox small">
        <div><strong>è›‹ç™½è³ªæç¤ºï¼ˆç°¡åŒ–ç‰ˆï¼‰ï¼š</strong>æ¯é¤å…ˆç¢ºä¿ã€Œè›‹ç™½è³ªå„ªå…ˆã€ï¼šé›/é­š/è›‹/è±†è…/å¸Œè‡˜ä¹³é…ªï¼›å””å¥½åªé£Ÿæ·¨ç¢³æ°´ã€‚</div>
        <div class="muted" style="margin-top:6px">ï¼ˆIBS-Dï¼PCOSï¼ç”¨ç·Š Ozempicï¼šå¤ªæ²¹ã€å¤ªè¾£ã€é…’ç²¾ã€éé‡å¥¶é¡ã€æ´‹è”¥è’œç­‰å¯èƒ½æœƒä»¤è…¸èƒƒå””èˆ’æœï¼Œè‡ªå·±ç”¨å‚™è¨»è¨˜è§¸ç™¼é»ã€‚ï¼‰</div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“Œ è¨ˆåŠƒ &amp; æé†’</h2>

      <div class="goodBox tips">
        <div><strong>90æ—¥ä¸»ç›®æ¨™ï¼š</strong>ç©©å®šæ¸›è„‚ã€ä¿è‚Œè‚‰ã€å¯æŒçºŒã€‚</div>
        <ul>
          <li>æ¯é€± 2 æ¬¡è·‘æ­¥ï¼ˆæ˜“è·‘/ç¯€å¥è·‘/é–“æ­‡è¼ªæ›¿éƒ½å¾—ï¼‰ï¼Œ1 æ¬¡ Gyrotonicã€‚</li>
          <li>æ¯æ—¥è‡³å°‘ä¸€é¤ã€Œé«˜è›‹ç™½ + è”¬èœã€ï¼Œç›¡é‡é¿å…ç©ºè‚šåªé£Ÿç”œ/ç²¾ç·»æ¾±ç²‰ã€‚</li>
          <li>é«”é‡ä¸€å…©æ—¥ä¸Šè½å¥½æ­£å¸¸ï¼šç•™æ„ 7æ—¥å¹³å‡è¶¨å‹¢ã€‚</li>
        </ul>
      </div>

      <div class="sep"></div>

      <div class="tips">
        <div><strong>æ‰“å¡é»ƒé‡‘è¦å‰‡ï¼š</strong></div>
        <ul>
          <li>æœ€å¥½æ¯æ—¥åŒä¸€æ™‚é–“é‡ï¼ˆä¾‹å¦‚èµ·èº«å»å»æ‰€å¾Œï¼‰ã€‚</li>
          <li>IBS-D / PMS ç™¼ä½œæ—¥ï¼Œè¨˜ä½é£Ÿå’—ä¹œã€å£“åŠ›ã€ç¡çœ ã€è…¸èƒƒåæ‡‰ã€‚</li>
          <li>å¦‚æœ 7â€“10 æ—¥éƒ½å†‡è¶¨å‹¢ä¸‹é™ï¼šå…ˆæª¢æŸ¥ã€Œè›‹ç™½è³ªä¸è¶³/é›¶é£Ÿ/é£²å“ç†±é‡/æ´»å‹•é‡ã€ã€‚</li>
        </ul>
      </div>

      <div class="sep"></div>

      <div class="chartCard">
        <div class="chartTitle">
          <div><strong>ğŸ“ˆ é«”é‡è¶¨å‹¢</strong> <span class="muted small">ï¼ˆæœ€è¿‘ 30 ç­†ï¼‰</span></div>
          <div class="pill" id="chartHint">â€”</div>
        </div>
        <canvas id="chart" width="600" height="260"></canvas>
        <div class="muted small" style="margin-top:8px">å¦‚æœåœ–è¡¨å””é¡¯ç¤ºï¼šé€šå¸¸ä¿‚æœªè¼¸å…¥ä»»ä½•é«”é‡ï¼Œå…ˆæ‰“å¡ä¸€æ¬¡å°±æœƒå‡ºã€‚</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h2>ğŸ“š è¿‘æœŸè¨˜éŒ„</h2>
    <div class="muted small">æç¤ºï¼šé»ã€Œæ¸…é™¤å…¨éƒ¨ã€å‰ï¼Œå»ºè­°å…ˆåŒ¯å‡º JSON ç•™åº•ã€‚</div>
    <div class="list" id="list"></div>
    <div class="muted" id="empty" style="padding:18px;text-align:center;display:none">æš«æ™‚æœªæœ‰è¨˜éŒ„ã€‚ç”±ä»Šæ—¥é–‹å§‹æ‰“å¡å•¦ã€‚</div>
  </div>
</div>

<script>
  const CONFIG = {
    startDate: "2026-02-23",
    durationDays: 90,
    goalLossKg: 6.0
  };

  const STORAGE_KEY = "fatloss90_v1_entries";

  function $(id){ return document.getElementById(id); }

  function toISO(d){
    const z = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  }

  function parseISO(s){
    const [y,m,d]=s.split("-").map(Number);
    return new Date(y, m-1, d);
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  function loadEntries(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){
      return [];
    }
  }

  function saveEntries(arr){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }

  function sortEntries(arr){
    return arr.slice().sort((a,b)=> (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
  }

  function getDayNumber(dateISO){
    const start = parseISO(CONFIG.startDate);
    const d = parseISO(dateISO);
    const diff = Math.floor((d - start) / (1000*60*60*24)) + 1;
    return diff;
  }

  function formatKg(x){
    if (x === null || x === undefined || x === "") return "â€”";
    const n = Number(x);
    if (Number.isNaN(n)) return "â€”";
    return n.toFixed(1);
  }

  function setDefaultsUI(){
    $("startDateText").textContent = CONFIG.startDate;
    $("goalLossText").textContent = CONFIG.goalLossKg.toFixed(1);
    $("entryDate").value = toISO(new Date());
    $("dayRangeHint").textContent = `Day 1 è‡³ Day ${CONFIG.durationDays}`;
  }

  function saveEntry(){
    const date = $("entryDate").value;
    const w = $("weight").value;
    const bf = $("bodyfat").value;
    const workout = $("workout").value;
    const notes = $("notes").value || "";

    if(!date){ alert("è«‹é¸æ—¥æœŸ"); return; }
    if(!w){ alert("è«‹è¼¸å…¥é«”é‡ï¼ˆkgï¼‰"); return; }

    const weight = Number(w);
    if(Number.isNaN(weight) || weight <= 0){ alert("é«”é‡æ ¼å¼å””æ­£ç¢º"); return; }

    const bodyfat = bf ? Number(bf) : null;
    if(bf && (Number.isNaN(bodyfat) || bodyfat <= 0 || bodyfat > 80)){
      alert("é«”è„‚æ ¼å¼å””æ­£ç¢ºï¼ˆæˆ–ç•™ç©ºï¼‰");
      return;
    }

    const day = getDayNumber(date);
    if(day < 1 || day > CONFIG.durationDays){
      const ok = confirm(`ä½ æ€å˜…æ—¥æœŸä¿‚è¨ˆåŠƒç¯„åœå¤–ï¼ˆDay ${day}ï¼‰ã€‚éƒ½è¦ç…§æ¨£å„²å­˜ï¼Ÿ`);
      if(!ok) return;
    }

    const entries = loadEntries();
    const filtered = entries.filter(x => x.date !== date);
    filtered.push({ date, weight, bodyfat, workout, notes, updatedAt: new Date().toISOString() });
    const sorted = sortEntries(filtered);
    saveEntries(sorted);

    $("weight").value = "";
    $("bodyfat").value = "";
    $("workout").value = "";
    $("notes").value = "";

    renderAll();
    alert("å·²å„²å­˜ âœ…");
  }

  function deleteEntry(date){
    const ok = confirm(`åˆªé™¤ ${date} å‘¢æ¢è¨˜éŒ„ï¼Ÿ`);
    if(!ok) return;
    const entries = loadEntries().filter(x => x.date !== date);
    saveEntries(entries);
    renderAll();
  }

  function clearAll(){
    const ok = confirm("çœŸä¿‚è¦æ¸…é™¤å…¨éƒ¨è¨˜éŒ„ï¼Ÿï¼ˆä¸å¯é‚„åŸï¼‰");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    renderAll();
  }

  function exportJSON(){
    const entries = loadEntries();
    const payload = {
      meta: {
        exportedAt: new Date().toISOString(),
        config: CONFIG,
        version: 1
      },
      entries
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `fatloss90_export_${toISO(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = () => {
      const file = input.files && input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.entries)) throw new Error("format");
          const cleaned = data.entries
            .filter(x => x && x.date && x.weight)
            .map(x => ({
              date: x.date,
              weight: Number(x.weight),
              bodyfat: (x.bodyfat === null || x.bodyfat === undefined || x.bodyfat === "") ? null : Number(x.bodyfat),
              workout: x.workout || "",
              notes: x.notes || "",
              updatedAt: x.updatedAt || new Date().toISOString()
            }))
            .filter(x => !Number.isNaN(x.weight) && x.weight > 0);

          const merged = sortEntries(cleaned);
          saveEntries(merged);
          renderAll();
          alert("åŒ¯å…¥å®Œæˆ âœ…");
        }catch(e){
          alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼å””æ­£ç¢º");
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  function computeStats(entries){
    const sorted = sortEntries(entries);
    const latest = sorted.length ? sorted[sorted.length - 1] : null;
    const first = sorted.length ? sorted[0] : null;

    const latestW = latest ? latest.weight : null;
    const startW = first ? first.weight : null;

    const targetW = (startW !== null && startW !== undefined) ? (startW - CONFIG.goalLossKg) : null;
    const remaining = (latestW !== null && targetW !== null) ? (latestW - targetW) : null;

    let progress = 0;
    if(startW !== null && latestW !== null){
      const lost = startW - latestW;
      progress = clamp((lost / CONFIG.goalLossKg) * 100, 0, 120);
    }

    return { latest, first, latestW, startW, targetW, remaining, progress };
  }

  function renderKPI(){
    const entries = loadEntries();
    const { latestW, remaining, progress } = computeStats(entries);

    const todayISO = toISO(new Date());
    const d = getDayNumber(todayISO);
    $("dayNumber").textContent = `Day ${d}`;

    $("latestWeight").textContent = latestW !== null ? formatKg(latestW) : "â€”";

    if(remaining === null || Number.isNaN(remaining)){
      $("remainingToGoal").textContent = "â€”";
    }else{
      const r = Math.max(0, remaining);
      $("remainingToGoal").textContent = r.toFixed(1);
    }

    $("progressBar").style.width = `${clamp(progress,0,100)}%`;

    if(entries.length === 0){
      $("progressText").textContent = "æœªé–‹å§‹ï¼šå…ˆè¼¸å…¥ç¬¬ä¸€æ—¥é«”é‡";
    }else{
      $("progressText").textContent = `ç›®æ¨™å®Œæˆåº¦ï¼š${Math.round(clamp(progress,0,100))}%ï¼ˆä»¥ç¬¬ä¸€ç­†é«”é‡ä½œèµ·é»ï¼‰`;
    }
  }

  function renderList(){
    const entries = loadEntries();
    const list = $("list");
    list.innerHTML = "";
    $("empty").style.display = entries.length ? "none" : "block";

    const show = entries.slice().reverse().slice(0, 30);

    show.forEach(e=>{
      const day = getDayNumber(e.date);
      const pill = (day >=1 && day <= CONFIG.durationDays) ? `Day ${day}` : `Day ${day}ï¼ˆç¯„åœå¤–ï¼‰`;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <div class="itemDate mono">${e.date}</div>
          <div class="pill">${pill}</div>
        </div>
        <div class="itemMid">
          <div class="mini">
            <div class="mLabel">é«”é‡</div>
            <div class="mVal mono">${formatKg(e.weight)} kg</div>
          </div>
          <div class="mini">
            <div class="mLabel">é«”è„‚</div>
            <div class="mVal mono">${e.bodyfat === null || e.bodyfat === undefined ? "â€”" : e.bodyfat.toFixed(1) + " %"}</div>
          </div>
          <div class="mini">
            <div class="mLabel">é‹å‹•</div>
            <div class="mVal">${e.workout ? e.workout : "â€”"}</div>
          </div>
        </div>
        <div class="note">${e.notes ? e.notes : "<span class='muted'>ï¼ˆå†‡å‚™è¨»ï¼‰</span>"}</div>
        <div class="btnRow" style="margin-top:10px">
          <button class="btnGhost" style="padding:9px 12px" onclick="prefill('${e.date}')">âœï¸ ç·¨è¼¯å‘¢æ—¥</button>
          <button class="btnDanger" style="padding:9px 12px" onclick="deleteEntry('${e.date}')">ğŸ—‘ï¸ åˆªé™¤</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function prefill(date){
    const entries = loadEntries();
    const e = entries.find(x => x.date === date);
    if(!e) return;
    $("entryDate").value = e.date;
    $("weight").value = e.weight;
    $("bodyfat").value = (e.bodyfat === null || e.bodyfat === undefined) ? "" : e.bodyfat;
    $("workout").value = e.workout || "";
    $("notes").value = e.notes || "";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function drawChart(){
    const canvas = $("chart");
    const ctx = canvas.getContext("2d");
    const entries = loadEntries();
    const last = entries.slice(-30);

    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || 600;
    const cssH = 260;
    canvas.style.height = cssH + "px";
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ctx.clearRect(0,0,cssW,cssH);

    if(last.length < 2){
      $("chartHint").textContent = "éœ€è¦è‡³å°‘ 2 ç­†é«”é‡";
      ctx.strokeStyle = "rgba(148,163,184,.35)";
      ctx.setLineDash([6,6]);
      ctx.strokeRect(10, 10, cssW-20, cssH-20);
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(148,163,184,.75)";
      ctx.font = "14px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("è¼¸å…¥è‡³å°‘å…©æ—¥é«”é‡ï¼Œå°±æœƒå‡ºè¶¨å‹¢ç·šã€‚", 22, 38);
      return;
    }

    const weights = last.map(x => x.weight);
    const minW = Math.min(...weights);
    const maxW = Math.max(...weights);
    const pad = 0.6;
    const lo = minW - pad;
    const hi = maxW + pad;

    const left = 36, right = 10, top = 12, bottom = 26;
    const w = cssW - left - right;
    const h = cssH - top - bottom;

    ctx.strokeStyle = "rgba(148,163,184,.18)";
    ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const y = top + (h * i/4);
      ctx.beginPath();
      ctx.moveTo(left, y);
      ctx.lineTo(left + w, y);
      ctx.stroke();
    }

    ctx.fillStyle = "rgba(148,163,184,.8)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    for(let i=0;i<=4;i++){
      const val = (hi - (hi-lo)*i/4);
      const y = top + (h * i/4);
      ctx.fillText(val.toFixed(1), 6, y+4);
    }

    const xFor = (i)=> left + (w * (i/(last.length-1)));
    const yFor = (wt)=> top + (h * (1 - ((wt-lo)/(hi-lo))));

    ctx.strokeStyle = "rgba(56,189,248,.95)";
    ctx.lineWidth = 2.2;
    ctx.beginPath();
    last.forEach((e,i)=>{
      const x = xFor(i);
      const y = yFor(e.weight);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle = "rgba(16,185,129,.95)";
    last.forEach((e,i)=>{
      const x = xFor(i);
      const y = yFor(e.weight);
      ctx.beginPath();
      ctx.arc(x,y,3.2,0,Math.PI*2);
      ctx.fill();
    });

    const delta = last[last.length-1].weight - last[0].weight;
    const sign = delta <= 0 ? "â†“" : "â†‘";
    $("chartHint").textContent = `æœ€è¿‘ ${last.length} ç­†ï¼š${sign} ${Math.abs(delta).toFixed(1)} kg`;
  }

  function renderAll(){
    renderKPI();
    renderList();
    drawChart();
  }

  setDefaultsUI();
  renderAll();
  window.addEventListener("resize", () => drawChart());
</script>
</body>
</html>
